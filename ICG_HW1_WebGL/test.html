<!doctype html>
<html lang="en">
    <head>
        <title>Perlin noise | Fireball explosion</title>
        <meta charset="utf-8">
    </head>

    <body>
        <div id="container"></div>
    </body>

    <script src="js/Three.js"></script>

    <script type="x-shader/x-vertex" id="vertexShader">
        varying vec2 vUv;
        varying float noise;
        uniform float time;

        float turbulence( vec3 p ) {
            float w = 100.0;
            float t = -.5;
            for (float f = 1.0 ; f <= 10.0 ; f++ ){
                float power = pow( 2.0, f );
                t += abs( pnoise( vec3( power * p ), vec3( 10.0, 10.0, 10.0 ) ) / power );
            }
            return t;
        }

        void main() {

            vUv = uv;

            // add time to the noise parameters so it's animated
            noise = 10.0 *  -.10 * turbulence( .5 * normal + time );
            float b = 5.0 * pnoise( 0.05 * position + vec3( 2.0 * time ), vec3( 100.0 ) );
            float displacement = - noise + b;
            
            vec3 newPosition = position + normal * displacement;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( newPosition, 1.0 );

        }
    </script>

    <script type="x-shader/x-vertex" id="fragmentShader">
        varying vec2 vUv;
        varying float noise;
        uniform sampler2D tExplosion;

        float random( vec3 scale, float seed ){
            return fract( sin( dot( gl_FragCoord.xyz + seed, scale ) ) * 43758.5453 + seed ) ;
        }

        void main() {

            // get a random offset
            float r = .01 * random( vec3( 12.9898, 78.233, 151.7182 ), 0.0 );
            // lookup vertically in the texture, using noise and offset
            // to get the right RGB colour
            vec2 tPos = vec2( 0, 1.0 - 1.3 * noise + r );
            vec4 color = texture2D( tExplosion, tPos );

            gl_FragColor = vec4( color.rgb, 1.0 );

        }
    </script>

    <script type="text/javascript" id="mainCode">
        var container, 
            renderer, 
            scene, 
            camera, 
            mesh, 
            start = Date.now(),
            fov = 30;

        window.addEventListener( 'load', function() {

            // grab the container from the DOM
            container = document.getElementById( "container" );
            
            // create a scene
            scene = new THREE.Scene();

            // create a camera the size of the browser window
            // and place it 100 units away, looking towards the center of the scene
            camera = new THREE.PerspectiveCamera( 
                fov, 
                window.innerWidth / window.innerHeight, 
                1, 
                10000 );
            camera.position.z = 100;
            camera.target = new THREE.Vector3( 0, 0, 0 );

            scene.add( camera );

            // create a wireframe material      
            material = new THREE.ShaderMaterial( {

                uniforms: { 
                    tExplosion: {
                        type: "t", 
                        value: THREE.ImageUtils.loadTexture( 'explosion.png' )
                    },
                    time: { // float initialized to 0
                        type: "f", 
                        value: 0.0 
                    }
                },
                vertexShader: document.getElementById( 'vertexShader' ).textContent,
                fragmentShader: document.getElementById( 'fragmentShader' ).textContent
                
            } );
            
            // create a sphere and assign the material
            mesh = new THREE.Mesh( 
                new THREE.IcosahedronGeometry( 20, 4 ), 
                material 
            );
            scene.add( mesh );
            
            // create the renderer and attach it to the DOM
            renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            material.uniforms[ 'time' ].value = .00025 * ( Date.now() - start );
            container.appendChild( renderer.domElement );

            render();

        } );

        function render() {

            // let there be light
            renderer.render( scene, camera );
            requestAnimationFrame( render );
            
        }
    </script>

</html>